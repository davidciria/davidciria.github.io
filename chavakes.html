<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>üèÜ Chavakes üèÄ‚öΩ</title>
  <style>
    /* === ESTILOS MODERNOS MOLONES === */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #f0f0f0;
      padding: 20px;
      margin: 0;
    }

    h2 {
      color: #ffffff;
      margin-bottom: 15px;
      text-shadow: 0px 2px 5px rgba(0, 0, 0, 0.6);
    }

    input,
    button {
      margin: 10px;
      padding: 12px 18px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      outline: none;
    }

    input {
      width: 220px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      backdrop-filter: blur(8px);
    }

    input::placeholder {
      color: #e0e0e0;
    }

    button {
      background: linear-gradient(135deg, #28a745, #1d7d34);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.3);
    }

    button:hover {
      transform: scale(1.05);
      background: linear-gradient(135deg, #34c759, #248f42);
    }

    #downloadLink {
      display: block;
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
      text-decoration: none;
      color: #34c3ff;
      transition: color 0.3s ease;
    }

    #downloadLink:hover {
      color: #ffffff;
    }

    #fileContent {
      overflow-wrap: break-word;
      padding: 20px;
      margin-top: 20px;
      border-radius: 20px;
      display: none;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      box-shadow: 0px 6px 15px rgba(0, 0, 0, 0.4);
    }

    .channel-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 15px;
      box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.4);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(12px);
    }

    .channel-card:hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0px 10px 20px rgba(0, 0, 0, 0.6);
    }

    .channel-logo {
      max-height: 70px;
      max-width: 70px;
      border-radius: 10px;
      margin-bottom: 10px;
      border: 2px solid #ffffff33;
    }

    .channel-info {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .channel-card h3 {
      margin: 5px 0;
      font-size: 20px;
      color: #ffffff;
    }

    .channel-card a {
      color: #34c3ff;
      text-decoration: none;
      font-weight: bold;
      word-break: break-all;
    }

    .channel-card a:hover {
      text-decoration: underline;
      color: #fff;
    }

    .epg-container {
      color: #f0f0f0;
      margin-top: 10px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 10px;
      font-size: 14px;
    }

    .epg-item h4 {
      margin: 5px 0;
      color: #ffda79;
    }

    .epg-item p {
      margin: 0;
      font-size: 13px;
      color: #ddd;
    }
  </style>
</head>

<body>
  <h2>üèÜ Chavakes üèÄ‚öΩ</h2>
  <input type="password" id="password" placeholder="üîë Contrasenya">
  <br>
  <div style="border-radius: 20px;background: rgba(255,255,255,0.12);padding:20px;backdrop-filter:blur(12px);box-shadow:0 6px 15px rgba(0,0,0,0.5);">
    <h2 style="padding-top: 10px;">‚ö° Utilitzar nom√©s si no tens reproductor</h2>
    <button><a href="https://drive.google.com/file/d/1fpVVYr52kXFQFu7vBRxuqw5u-pg1HLo2/view?usp=sharing"
        target="_blank" style="color: white;text-decoration:none;">üì• Descarregar Reproductor Encriptat</a></button>
    <div style="display: flex; flex-wrap: wrap; width: 100%; justify-content: center;">
      <button onclick="document.getElementById('fileInput').click()">üìÇ Selecciona Reproductor</button>
      <input type="file" id="fileInput" style="max-width: 100%; display:none;" type="file">
    </div>
    <button onclick="decryptFile()">üîì Desencriptar Reproductor</button>
  </div>
  <br>
  <button onclick="fetchAndDecryptFile()">üì• Desencriptar Llista</button>
  <br>
  <a id="downloadLink" style="display: none;">üìÇ Descargar Archivo</a>

  <input type="text" id="buscador" placeholder="üîé Buscador" style="display: none;" oninput="updateSearch()">
  <div id="fileContent"></div>

  <!-- üöÄ JavaScript original incluido -->
  <script>
    async function encryptData(data, password) {
      const key = await deriveKey(password);
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const encryptedData = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        key,
        data
      );
      return { encryptedData, iv };
    }

    async function decryptData(encryptedData, iv, password) {
      const key = await deriveKey(password);
      return crypto.subtle.decrypt(
        { name: "AES-GCM", iv },
        key,
        encryptedData
      );
    }

    async function deriveKey(password) {
      const encoder = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        "raw",
        encoder.encode(password),
        { name: "PBKDF2" },
        false,
        ["deriveKey"]
      );
      return crypto.subtle.deriveKey(
        {
          name: "PBKDF2",
          salt: encoder.encode("salt"),
          iterations: 100000,
          hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }

    async function decryptFile() {
      const fileInput = document.getElementById("fileInput");
      const password = document.getElementById("password").value;
      if (!password || fileInput.files.length === 0) {
        alert("Introdueix la contrasenya i selecciona el reproductor encriptat");
        return;
      }

      const file = fileInput.files[0];
      const key = await deriveKey(password);
      let decryptedChunks = [];

      const reader = new FileReader();
      reader.onload = async function (event) {
        try {
          const arrayBuffer = event.target.result;
          let offset = 0;

          while (offset < arrayBuffer.byteLength) {
            const iv = new Uint8Array(arrayBuffer.slice(offset, offset + 12));
            offset += 12;
            const lengthArray = new Uint32Array(arrayBuffer.slice(offset, offset + 4));
            const encryptedDataLength = lengthArray[0];
            offset += 4;
            const encryptedChunk = arrayBuffer.slice(offset, offset + encryptedDataLength);
            offset += encryptedDataLength;

            try {
              const decryptedData = await crypto.subtle.decrypt(
                { name: "AES-GCM", iv },
                key,
                encryptedChunk
              );
              decryptedChunks.push(new Uint8Array(decryptedData));
            } catch {
              alert("Contrasenya incorrecte");
              return;
            }
          }

          const blob = new Blob(decryptedChunks, { type: "application/octet-stream" });
          const url = URL.createObjectURL(blob);
          const downloadLink = document.getElementById("downloadLink");
          downloadLink.href = url;
          downloadLink.download = "player.exe";
          downloadLink.style.display = "block";
          downloadLink.innerText = "üìÇ Descarregar Reproductor Desencriptat"

        } catch (error) {
          console.error("Error general:", error);
          alert("Error al procesar el archivo.");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    var canales = [];

    async function updateSearch() {
      const buscador = document.getElementById("buscador");
      const fileContent = document.getElementById("fileContent");
      fileContent.innerHTML = '';
      canales.forEach((c, i) => {
        if (c.nombre.toLowerCase().includes(buscador.value.toLowerCase())) {
          fileContent.innerHTML += `
              <div class="channel-card">
                <img class="channel-logo" src="${c.tvgLogo}" alt="${c.nombre}">
                <div class="channel-info">
                  <h3>${i + 1}. ${c.nombre}</h3>
                  <a href="acestream://${c.enlace}" target="_blank">${c.enlace}</a>
                  <button onclick="showEpg('${c.tvgId}', 'epg-${i}')">üì∫ Ver programaci√≥n</button>
                </div>
                <div id="epg-${i}" class="epg-container"></div>
              </div>`;
        }
      });
    }

    async function fetchAndDecryptFile() {
      const url = "https://davidciria.github.io/file";
      const password = document.getElementById("password").value;
      if (!url || !password) {
        alert("Introdueix la contrasenya");
        return;
      }
      try {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const iv = new Uint8Array(arrayBuffer.slice(0, 12));
        const encryptedData = arrayBuffer.slice(12);
        const decryptedData = await decryptData(encryptedData, iv, password);

        const textDecoder = new TextDecoder();
        const fileContent = document.getElementById("fileContent");
        const buscador = document.getElementById("buscador");
        let textContent = textDecoder.decode(decryptedData);

        const regex = /#EXTINF:-1\s+tvg-logo="([^"]*)"\s+tvg-id="([^"]*)"\s+group-title="([^"]*)"(?:,\s*([^,]+))?\s*acestream:\/\/([a-f0-9]+)/g;

        let resultado;
        canales = [];

        while ((resultado = regex.exec(textContent)) !== null) {
          const tvgLogo = resultado[1];
          const tvgId = resultado[2];
          const groupTitle = resultado[3];
          const nombre = resultado[4].trim();
          const enlace = resultado[5];
          canales.push({ tvgLogo, tvgId, groupTitle, nombre, enlace });
        }

        fileContent.innerHTML = '';
        canales.forEach((c, i) => {
          if (c.nombre.toLowerCase().includes(buscador.value.toLowerCase())) {
            fileContent.innerHTML += `
                <div class="channel-card">
                  <img class="channel-logo" src="${c.tvgLogo}" alt="${c.nombre}">
                  <div class="channel-info">
                    <h3>${i + 1}. ${c.nombre}</h3>
                    <a href="acestream://${c.enlace}" target="_blank">${c.enlace}</a>
                    <button onclick="showEpg('${c.tvgId}', 'epg-${i}')">üì∫ Ver programaci√≥n</button>
                  </div>
                  <div id="epg-${i}" class="epg-container"></div>
                </div>`;
          }
        });

        fileContent.style.display = "block";
        buscador.style.display = "inline";

      } catch (error) {
        alert("Error al descarregar o desencriptar, revisa contrasenya");
        console.error(error);
      }
    }

    let epgXmlDoc = null;

    async function loadEpg() {
      const epgUrl = "https://corsproxy.io/?url=https://raw.githubusercontent.com/davidmuma/EPG_dobleM/master/guiatv.xml";
      try {
        const response = await fetch(epgUrl);
        const epgXml = await response.text();
        const parser = new DOMParser();
        epgXmlDoc = parser.parseFromString(epgXml, "text/xml");
      } catch (error) {
        console.error("Error cargando EPG:", error);
      }
    }

    function parseEpgDate(epgDate) {
      const rawDate = epgDate.split(" ")[0];
      const tzOffset = epgDate.split(" ")[1] || "+0000";
      const sign = tzOffset[0] === "+" ? 1 : -1;
      const hoursOffset = parseInt(tzOffset.substring(1, 3), 10);
      const minutesOffset = parseInt(tzOffset.substring(3, 5), 10);
      const totalOffsetMinutes = sign * (hoursOffset * 60 + minutesOffset);

      const dateUtc = new Date(Date.UTC(
        parseInt(rawDate.substring(0, 4)),
        parseInt(rawDate.substring(4, 6)) - 1,
        parseInt(rawDate.substring(6, 8)),
        parseInt(rawDate.substring(8, 10)),
        parseInt(rawDate.substring(10, 12)),
        parseInt(rawDate.substring(12, 14))
      ));
      return new Date(dateUtc.getTime() - totalOffsetMinutes * 60000);
    }

    function getEpgForChannel(channelName) {
      if (!epgXmlDoc) return { current: null, next: null };
      const now = new Date();
      const programs = [...epgXmlDoc.querySelectorAll("programme")]
        .map(program => ({
          channel: program.getAttribute("channel"),
          title: program.querySelector("title")?.textContent || "Desconocido",
          description: program.querySelector("desc")?.textContent || "Sin descripci√≥n",
          start: parseEpgDate(program.getAttribute("start")),
          stop: parseEpgDate(program.getAttribute("stop"))
        }))
        .filter(p => p.channel.toLowerCase() === channelName.toLowerCase())
        .sort((a, b) => a.start - b.start);

      const current = programs.find(p => now >= p.start && now < p.stop) || null;
      const next = programs.find(p => p.start > now) || null;
      return { current, next };
    }

    function formatTime(date) {
      return new Intl.DateTimeFormat("es-ES", {
        hour: "2-digit",
        minute: "2-digit",
        timeZone: "Europe/Madrid"
      }).format(date);
    }

    function showEpg(channelName, containerId) {
      const epgData = getEpgForChannel(channelName);
      const container = document.getElementById(containerId);

      if (!epgData || (!epgData.current && !epgData.next)) {
        container.innerHTML = "<p>No hay programaci√≥n disponible.</p>";
        return;
      }

      let epgHtml = "";
      if (epgData.current) {
        epgHtml += `<div class="epg-item">
          <h4>üî¥ Ahora: ${epgData.current.title} (${formatTime(epgData.current.start)} - ${formatTime(epgData.current.stop)})</h4>
          <p>${epgData.current.description}</p>
        </div>`;
      }
      if (epgData.next) {
        epgHtml += `<div class="epg-item">
          <h4>‚ñ∂Ô∏è Siguiente: ${epgData.next.title} (${formatTime(epgData.next.start)} - ${formatTime(epgData.next.stop)})</h4>
          <p>${epgData.next.description}</p>
        </div>`;
      }
      container.innerHTML = epgHtml;
    }

    loadEpg();
  </script>
</body>

</html>